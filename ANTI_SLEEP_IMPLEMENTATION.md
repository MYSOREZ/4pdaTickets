# Реализация механизмов защиты от усыпления приложения

## ⚠️ ВАЖНО: Обновление для Android 15

С Android 15 введены жесткие ограничения на foreground-сервисы типа `dataSync`:
- Максимум 6 часов работы за 24 часа
- После исчерпания лимита система вызывает `onTimeout()` и требует остановки
- Повторный запуск возможен только после взаимодействия пользователя

**Решение**: Приложение теперь использует гибридную схему:
1. **Точные будильники** каждые 5 минут (требует разрешение SCHEDULE_EXACT_ALARM)
2. **WorkManager** как резерв каждые 15 минут
3. **Обычные ongoing-уведомления** вместо постоянного FGS

## Внесенные изменения

### 1. Новые классы (обновлено для Android 15)

#### FileLogger.kt
- **НОВЫЙ**: Система логирования в файл для отладки
- Сохраняет логи в `/storage/emulated/0/4pdaTickets/logs/`
- Автоматическая ротация файлов (максимум 5 файлов по 5 МБ)
- Очистка старых логов (старше 7 дней)
- Интеграция с Debug Menu для просмотра логов

#### ExactAlarmScheduler.kt
- Планировщик точных будильников для частых проверок (каждые 5 минут)
- Обходит ограничение Android 15 на 6 часов работы FGS
- Требует разрешение SCHEDULE_EXACT_ALARM на Android 12+

#### ExactAlarmReceiver.kt
- Ресивер для точных будильников
- Запускает короткие задачи проверки без постоянного FGS
- Использует WakeLock для гарантии выполнения

#### QuickCheckWorker.kt
- **ОПТИМИЗИРОВАН**: Worker для быстрой проверки тикетов (до 15 секунд)
- Создает минимальный WebView с отключенными изображениями
- Выполняет проверку за 4 секунды и немедленно завершается
- Обновляет ongoing-уведомление БЕЗ FGS
- Использует proper constraints для WorkManager

#### KeepAliveWorker.kt
- Использует WorkManager для периодической проверки состояния сервиса каждые 15 минут
- Автоматически перезапускает сервис если он был остановлен системой
- Более устойчив к усыплению чем обычные сервисы

#### AlarmReceiver.kt
- Использует AlarmManager для пробуждения приложения каждые 30 минут
- Применяет WakeLock для гарантии выполнения проверки
- Использует точные аллармы для надежности (требует разрешения SCHEDULE_EXACT_ALARM)

### 2. Обновленные файлы

#### AndroidManifest.xml
- Добавлены разрешения: `SCHEDULE_EXACT_ALARM`, `USE_EXACT_ALARM`
- Добавлены разрешения: `WRITE_EXTERNAL_STORAGE`, `READ_EXTERNAL_STORAGE`
- Зарегистрирован AlarmReceiver и ExactAlarmReceiver
- Удален атрибут package (устаревший)

#### ForegroundMonitorService.kt
- **КРИТИЧНО**: Добавлена обработка `onTimeout()` для Android 15
- При тайм-ауте сервис немедленно останавливается через `stopSelf()`
- Показывает уведомление пользователю о необходимости перезапуска
- Добавлена обработка ACTION_PING от KeepAliveWorker
- Добавлена обработка ACTION_KEEP_ALIVE от AlarmReceiver

#### MainActivity.kt
- **Новая схема запуска**: приоритет точным будильникам каждые 5 минут
- Запрос разрешения SCHEDULE_EXACT_ALARM на Android 12+
- Запрос разрешения WRITE_EXTERNAL_STORAGE для логирования
- Fallback на WorkManager (15 минут) если разрешение не предоставлено
- При запуске мониторинга запускаются все механизмы защиты
- При остановке отменяются все будильники и уведомления
- Логирование ключевых событий в файл

#### BootReceiver.kt
- При автозапуске также активируются механизмы защиты от усыпления

#### SettingsActivity.kt
- Добавлен метод formatTime() для форматирования времени

#### build.gradle.kts
- Добавлена зависимость: `androidx.work:work-runtime-ktx:2.9.0`

### 3. Исправленные ошибки
- MIN_BACKOFF_MILLIS заменен на WorkRequest.MIN_BACKOFF_MILLIS
- Добавлен отсутствующий метод formatTime()

## Как это работает (обновлено для Android 15)

### Новая архитектура (рекомендуется):
1. **Точные будильники** (ExactAlarmScheduler) - пробуждают устройство каждые 5 минут
2. **Быстрые проверки** (QuickCheckWorker) - выполняют проверку за 25 секунд и завершаются
3. **Ongoing-уведомления** - показывают статус без постоянного FGS
4. **WakeLock** - гарантирует выполнение критических операций

### Резервные механизмы:
1. **WorkManager** (KeepAliveWorker) - проверка каждые 15 минут
2. **AlarmManager** (AlarmReceiver) - пробуждение каждые 30 минут  
3. **ForegroundService** - только при необходимости, с обработкой `onTimeout()`

### Преимущества новой схемы:
- ✅ Обходит лимит Android 15 на 6 часов
- ✅ Частые проверки (интервал по выбору пользователя, по умолчанию 5 минут)
- ✅ Экономное использование exact alarms
- ✅ Минимальное потребление ресурсов (15 секунд на проверку)
- ✅ Ongoing-уведомления без постоянного FGS
- ✅ Автовосстановление после перезагрузки
- ✅ Совместимость с Android < 15 и Android 15+
- ✅ **Подробное логирование** в файл для диагностики проблем
- ✅ **Debug Menu** с просмотром логов и диагностикой

## Сборка проекта

1. Откройте проект в Android Studio
2. Синхронизируйте Gradle файлы (File → Sync Project with Gradle Files)
3. Соберите проект (Build → Make Project)

## Настройка устройства

См. файл MIUI_SETTINGS.md для инструкций по настройке MIUI.

## Тестирование

После сборки и установки:
1. Предоставьте разрешения на уведомления и запись во внешнее хранилище
2. Предоставьте разрешение на точные будильники (Android 12+)
3. Запустите мониторинг
4. Сверните приложение
5. Подождите несколько часов
6. Проверьте работу через Debug Menu → "Просмотр лог-файлов"
7. Лог-файлы сохраняются в `/storage/emulated/0/4pdaTickets/logs/`

## Диагностика проблем

Если мониторинг не работает:
1. Откройте Debug Menu (Настройки → Debug Menu)
2. Нажмите "Просмотр лог-файлов"
3. Изучите последние записи в логах
4. Проверьте наличие сообщений об ошибках или тайм-аутах
5. Убедитесь что точные будильники работают (записи каждые 5 минут)
